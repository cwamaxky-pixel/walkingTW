<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ç£æ­¥å±¥ - å¸¶æˆ‘ä¸€èµ·èµ°</title>
    <!-- å¼•å…¥åœ°åœ–æ¨£å¼ Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- å¼•å…¥ Tailwind CSS ç¾åŒ–ä»‹é¢ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #map { height: 500px; width: 100%; border-radius: 12px; z-index: 1; }
        .custom-icon { font-size: 24px; text-align: center; }
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f3f4f6; }
    </style>
</head>
<body class="pb-10">

    <!-- æ¨™é¡Œå€ -->
    <div class="bg-blue-600 text-white p-6 text-center shadow-lg">
        <h1 class="text-3xl font-bold mb-2">å°ç£æ­¥å±¥ TW Walker</h1>
        <p class="text-sm opacity-90">10 é€±ï½œ75 è¬æ­¥ï½œç”¨é›™è…³æŠŠæ¯ä¸€æ­¥èµ°æˆæ•…äº‹</p>
    </div>

    <div class="max-w-md mx-auto mt-6 px-4">
        
        <!-- è¼¸å…¥å€ -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-6">
            <label class="block text-gray-700 font-bold mb-2">ğŸ“Š è¼¸å…¥ç›®å‰çš„ç´¯ç©ç¸½æ­¥æ•¸</label>
            <div class="flex gap-2">
                <input type="number" id="inputSteps" placeholder="ä¾‹å¦‚ï¼š150000" class="flex-1 p-3 border rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="updateProgress()" class="bg-blue-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-600 transition">æ›´æ–°</button>
            </div>
            <p class="text-xs text-gray-400 mt-2">* è«‹æ‰“é–‹æ‰‹æ©Ÿå¥åº·Appï¼ŒæŸ¥çœ‹å¾ 12/8 è‡³ä»Šçš„ç¸½æ­¥æ•¸å¡«å…¥</p>
        </div>

        <!-- ç‹€æ…‹å„€è¡¨æ¿ -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-6 space-y-4">
            <div class="flex justify-between items-center border-b pb-4">
                <div>
                    <p class="text-gray-500 text-sm">ç›®å‰ä½ç½®</p>
                    <h2 class="text-2xl font-bold text-blue-800" id="currentLocation">æº–å‚™å‡ºç™¼</h2>
                </div>
                <div class="text-right">
                    <p class="text-gray-500 text-sm">ç›®æ¨™é€²åº¦</p>
                    <h2 class="text-xl font-bold" id="progressPercent">0%</h2>
                </div>
            </div>
            
            <div>
                <p class="text-gray-500 text-sm mb-1">æœ¬é€±ç›®æ¨™ (<span id="currentWeekDate">æª¢æŸ¥ä¸­...</span>)</p>
                <div class="w-full bg-gray-200 rounded-full h-4">
                    <div id="progressBar" class="bg-green-500 h-4 rounded-full transition-all duration-1000" style="width: 0%"></div>
                </div>
                <p class="text-sm mt-2 font-medium" id="statusMsg">åŠ æ²¹ï¼æ—…ç¨‹å‰›é–‹å§‹ã€‚</p>
            </div>
        </div>

        <!-- åœ°åœ–å€ -->
        <div class="bg-white p-2 rounded-xl shadow-md">
            <div id="map"></div>
        </div>

        <!-- é€²åº¦è¡¨åƒè€ƒ (å¯æŠ˜ç–Š) -->
        <div class="mt-6 text-center">
            <details class="group">
                <summary class="list-none flex flex-wrap items-center cursor-pointer focus:outline-none bg-white p-4 rounded-lg shadow-sm">
                    <span class="flex-1 text-left font-bold text-gray-700">ğŸ“œ æŸ¥çœ‹è©³ç´°é€²åº¦è¡¨</span>
                    <span class="text-blue-500">â–¼</span>
                </summary>
                <div class="bg-white mt-2 p-4 rounded-lg shadow-sm text-sm text-left overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead>
                            <tr class="bg-gray-100 text-gray-600">
                                <th class="p-2 text-left">ç›®æ¨™</th>
                                <th class="p-2 text-left">æ—¥æœŸ</th>
                                <th class="p-2 text-right">ç´¯ç©æ­¥æ•¸</th>
                            </tr>
                        </thead>
                        <tbody id="scheduleTable">
                            <!-- JS è‡ªå‹•ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
            </details>
        </div>
    </div>

    <!-- å¼•å…¥ Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- 1. è³‡æ–™è¨­å®š (æ ¹æ“šä½ çš„è¡¨æ ¼) ---
        const startDate = new Date("2024-12-08");
        const milestones = [
            { name: "æ·¡æ°´ (Start)", date: "2024-12-08", steps: 0, lat: 25.17, lng: 121.44 },
            { name: "æ¡ƒåœ’", date: "2024-12-14", steps: 63000, lat: 24.99, lng: 121.30 },
            { name: "æ–°ç«¹", date: "2024-12-21", steps: 154000, lat: 24.80, lng: 120.96 },
            { name: "è‹—æ —", date: "2024-12-28", steps: 224000, lat: 24.56, lng: 120.82 },
            { name: "å°ä¸­", date: "2025-01-04", steps: 322000, lat: 24.14, lng: 120.68 },
            { name: "å½°åŒ–", date: "2025-01-11", steps: 378000, lat: 24.08, lng: 120.54 },
            { name: "é›²æ—", date: "2025-01-18", steps: 455000, lat: 23.70, lng: 120.53 },
            { name: "å˜‰ç¾©", date: "2025-01-25", steps: 511000, lat: 23.48, lng: 120.44 },
            { name: "å°å—", date: "2025-02-01", steps: 609000, lat: 22.99, lng: 120.21 },
            { name: "é«˜é›„", date: "2025-02-08", steps: 672000, lat: 22.62, lng: 120.30 },
            { name: "å¢¾ä¸ (Goal)", date: "2025-02-15", steps: 756000, lat: 21.94, lng: 120.79 }
        ];

        // --- 2. åˆå§‹åŒ–åœ°åœ– ---
        const map = L.map('map').setView([23.5, 120.5], 7); // è¦–è§’è¨­åœ¨å°ç£ä¸­å¿ƒ

        // åŠ å…¥ OpenStreetMap åœ–å±¤
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 18
        }).addTo(map);

        // ç¹ªè£½è·¯å¾‘ç·š (Polyline)
        const latlngs = milestones.map(m => [m.lat, m.lng]);
        const polyline = L.polyline(latlngs, {color: '#3b82f6', weight: 5, opacity: 0.7}).addTo(map);

        // åŠ å…¥å„ç«™é»æ¨™è¨˜
        milestones.forEach(m => {
            L.circleMarker([m.lat, m.lng], {
                radius: 6,
                fillColor: "#1d4ed8",
                color: "#fff",
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(map).bindPopup(`<b>${m.name}</b><br>ç›®æ¨™: ${m.steps.toLocaleString()} æ­¥<br>æœŸé™: ${m.date}`);
        });

        // ç©å®¶æ¨™è¨˜ (å°äºº)
        const playerIcon = L.divIcon({
            className: 'custom-icon',
            html: 'ğŸš¶',
            iconSize: [30, 30],
            iconAnchor: [15, 30]
        });
        let playerMarker = L.marker([25.17, 121.44], {icon: playerIcon}).addTo(map);

        // --- 3. é‚è¼¯é‹ç®— ---

        // åˆå§‹åŒ–è¡¨æ ¼
        const tableBody = document.getElementById('scheduleTable');
        milestones.forEach((m, index) => {
            if(index === 0) return; 
            const row = `<tr>
                <td class="p-2 border-b">${m.name}</td>
                <td class="p-2 border-b text-xs text-gray-500">${m.date}</td>
                <td class="p-2 border-b text-right font-mono">${m.steps.toLocaleString()}</td>
            </tr>`;
            tableBody.innerHTML += row;
        });

        // è®€å–å„²å­˜çš„æ­¥æ•¸ (LocalStorage)
        const savedSteps = localStorage.getItem('twWalkerSteps');
        if (savedSteps) {
            document.getElementById('inputSteps').value = savedSteps;
            updateProgress(parseInt(savedSteps));
        } else {
            updateProgress(0);
        }

        // æ›´æ–°é€²åº¦ä¸»å‡½å¼
        function updateProgress(manualSteps = null) {
            let steps = manualSteps !== null ? manualSteps : parseInt(document.getElementById('inputSteps').value) || 0;
            
            // å„²å­˜åˆ°ç€è¦½å™¨ï¼Œä¸‹æ¬¡ä¸ç”¨é‡æ‰“
            localStorage.setItem('twWalkerSteps', steps);

            // 1. æ‰¾å‡ºç›®å‰å€é–“
            let currentLegStart = milestones[0];
            let currentLegEnd = milestones[1];
            let legIndex = 0;

            for (let i = 0; i < milestones.length - 1; i++) {
                if (steps >= milestones[i].steps) {
                    currentLegStart = milestones[i];
                    currentLegEnd = milestones[i+1];
                    legIndex = i;
                }
            }

            // å¦‚æœç ´é—œäº†
            if (steps >= milestones[milestones.length - 1].steps) {
                currentLegStart = milestones[milestones.length - 1];
                currentLegEnd = milestones[milestones.length - 1];
                document.getElementById('currentLocation').innerText = "ğŸ† å·²æŠµé”å¢¾ä¸ï¼";
                document.getElementById('statusMsg').innerText = "å¤ªå¼·äº†ï¼ä½ å·²ç¶“å®Œæˆäº†ç’°å³¶æŒ‘æˆ°ï¼";
                document.getElementById('statusMsg').className = "text-sm mt-2 font-bold text-green-600";
                document.getElementById('progressBar').style.width = "100%";
                document.getElementById('progressPercent').innerText = "100%";
                // ç§»åˆ°çµ‚é»
                playerMarker.setLatLng([milestones[milestones.length-1].lat, milestones[milestones.length-1].lng]);
                return;
            }

            // 2. è¨ˆç®—å€é–“ç™¾åˆ†æ¯”èˆ‡åº§æ¨™æ’å€¼
            let legTotalSteps = currentLegEnd.steps - currentLegStart.steps;
            let stepsInLeg = steps - currentLegStart.steps;
            let percentInLeg = stepsInLeg / legTotalSteps;

            // ç·šæ€§æ’å€¼è¨ˆç®—åº§æ¨™
            let currentLat = currentLegStart.lat + (currentLegEnd.lat - currentLegStart.lat) * percentInLeg;
            let currentLng = currentLegStart.lng + (currentLegEnd.lng - currentLegStart.lng) * percentInLeg;

            // æ›´æ–°åœ°åœ–ä½ç½®
            playerMarker.setLatLng([currentLat, currentLng]);
            map.flyTo([currentLat, currentLng], 9); // é£›åˆ°ç•¶å‰ä½ç½®

            // 3. æ›´æ–°æ–‡å­—ä»‹é¢
            let nextCity = currentLegEnd.name;
            document.getElementById('currentLocation').innerText = `å‰å¾€ ${nextCity}`;
            
            let totalProgress = (steps / 756000 * 100).toFixed(1);
            document.getElementById('progressPercent').innerText = `${totalProgress}%`;
            document.getElementById('progressBar').style.width = `${totalProgress}%`;

            // 4. æ™‚é–“æª¢æŸ¥é‚è¼¯
            checkScheduleStatus(steps);
        }

        function checkScheduleStatus(currentSteps) {
            const today = new Date();
            // æ¨¡æ“¬æ¸¬è©¦ç”¨ (ä½ å¯ä»¥æŠŠä¸‹é¢é€™è¡Œè¨»è§£æ‰ï¼Œå°±æœƒæŠ“çœŸå¯¦æ—¥æœŸ)
            // const today = new Date("2024-12-25"); 

            // æ‰¾å‡ºä»Šå¤©æ‡‰è©²è¦åœ¨å“ªå€‹éšæ®µ
            let targetStepsToday = 0;
            let currentWeekTarget = null;
            let weekInfo = "";

            // ç°¡å–®åˆ¤æ–·ï¼šå¦‚æœä»Šå¤©æ—¥æœŸå¤§æ–¼æŸå€‹milestoneæ—¥æœŸï¼Œé‚£ç›®æ¨™æ­¥æ•¸è‡³å°‘è¦æ˜¯è©²milestoneçš„æ­¥æ•¸
            for (let i = 0; i < milestones.length; i++) {
                let mDate = new Date(milestones[i].date);
                if (today <= mDate) {
                    currentWeekTarget = milestones[i];
                    weekInfo = `${milestones[i].date} å‰æŠµé” ${milestones[i].name}`;
                    targetStepsToday = milestones[i].steps; 
                    // é€™è£¡å¯ä»¥åšæ›´ç´°çš„ç·šæ€§æ¨ç®—ï¼Œç›®å‰å…ˆç°¡å–®æŠ“è©²é€±ç›®æ¨™
                    break;
                }
            }

            if (!currentWeekTarget) {
                // æ—¥æœŸè¶…éæœ€å¾Œä¸€å¤©
                weekInfo = "æ´»å‹•å·²çµæŸ";
            }

            document.getElementById('currentWeekDate').innerText = weekInfo;

            // æ¯”è¼ƒé€²åº¦
            // é€™è£¡åšä¸€å€‹ç°¡å–®çš„æ¯æ—¥ä¼°ç®—ï¼šå‡è¨­ç•¶é€±æ˜¯ç·šæ€§å¢é•·
            // ç‚ºäº†ç°¡åŒ–ï¼Œæˆ‘å€‘å…ˆæ¯”è¼ƒã€Œç›®å‰æ˜¯å¦é”åˆ°ä¸Šé€±ç›®æ¨™ã€æˆ–ã€Œè·é›¢æœ¬é€±ç›®æ¨™é‚„æœ‰å¤šé ã€
            
            const msgEl = document.getElementById('statusMsg');
            if (currentWeekTarget) {
                let remaining = currentWeekTarget.steps - currentSteps;
                if (remaining <= 0) {
                    msgEl.innerText = "ğŸ”¥ ç‹€æ…‹ï¼šè¶…å‰é€²åº¦ï¼ä½ èµ°å¾—éå¸¸å¿«ï¼";
                    msgEl.className = "text-sm mt-2 font-bold text-green-600";
                } else {
                    msgEl.innerText = `âš¡ ç‹€æ…‹ï¼šè·é›¢æœ¬é€±ç›®æ¨™ (${currentWeekTarget.name}) é‚„æœ‰ ${remaining.toLocaleString()} æ­¥`;
                    msgEl.className = "text-sm mt-2 font-bold text-blue-600";
                    
                    // å¦‚æœè½å¾Œå¤ªå¤š (é€™è£¡ç°¡å–®åˆ¤æ–·ï¼šå¦‚æœé€£ä¸Šä¸€é€±çš„ç›®æ¨™éƒ½æ²’é”åˆ°)
                    // å¯¦éš›é‚è¼¯å¯ä¾éœ€æ±‚èª¿æ•´
                }
            }
        }

        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œä¸€æ¬¡
        window.onload = function() {
            // å¦‚æœæœ‰å­˜æª”å‰‡è®€å–ï¼Œå¦å‰‡é è¨­0
            if(localStorage.getItem('twWalkerSteps')) {
                updateProgress();
            }
        }

    </script>
</body>
</html>
